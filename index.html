<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kandar Capital - Ultra Pro Trading Journal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.min.js"></script>
  <style>
    body { background: linear-gradient(to bottom right, #0f172a, #1e293b); min-height: 100vh; }
    .sidebar { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-right: 1px solid rgba(59, 130, 246, 0.3); }
    .hover-glow:hover { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); transition: all 0.3s ease; }
    .card:hover { transform: translateY(-4px); transition: all 0.3s; }
  </style>
</head>
<body class="text-white">
  <div class="drawer lg:drawer-open">
    <input id="sidebar-drawer" type="checkbox" class="drawer-toggle" />
    <div class="drawer-content flex flex-col">
      <div class="navbar bg-base-300/80 backdrop-blur-md lg:hidden sticky top-0 z-10">
        <label for="sidebar-drawer" class="btn btn-primary drawer-button">‚ò∞ Menu</label>
        <div class="flex-1 text-2xl font-bold text-primary text-center">Kandar Capital</div>
      </div>
      <div class="p-6 lg:p-10" id="main-content"></div>
    </div>
    <div class="drawer-side z-20">
      <label for="sidebar-drawer" class="drawer-overlay"></label>
      <ul class="menu p-6 w-72 h-full sidebar">
        <li class="text-4xl font-bold text-primary mb-12 text-center">Kandar Capital</li>
        <li><a onclick="showTab('dashboard')" class="text-xl py-4 hover-glow rounded-box">üìä Dashboard</a></li>
        <li><a onclick="showTab('journal')" class="text-xl py-4 hover-glow rounded-box">üìù Journal</a></li>
        <li><a onclick="showTab('add')" class="text-xl py-4 hover-glow rounded-box">‚ûï Add/Edit Trade</a></li>
        <li><a onclick="showTab('stats')" class="text-xl py-4 hover-glow rounded-box">üìà Statistics</a></li>
        <li><a onclick="showTab('settings')" class="text-xl py-4 hover-glow rounded-box">‚öôÔ∏è Settings</a></li>
      </ul>
    </div>
  </div>

  <script>
    let trades = JSON.parse(localStorage.getItem('kandarTrades') || '[]');
    let settings = JSON.parse(localStorage.getItem('kandarSettings') || '{"initial":10000,"currency":"$","theme":"dark"}');
    let charts = {};
    let editIndex = -1;

    function applySettings() {
      document.documentElement.setAttribute('data-theme', settings.theme);
    }

    function saveSettings() {
      localStorage.setItem('kandarSettings', JSON.stringify(settings));
      applySettings();
      renderAll();
    }

    function saveTrades() {
      localStorage.setItem('kandarTrades', JSON.stringify(trades));
      renderAll();
    }

    function renderContent(html) {
      document.getElementById('main-content').innerHTML = html;
      if (document.getElementById('searchInput')) document.getElementById('searchInput').onkeyup = searchJournal;
    }

    function calculateStats() {
      if (trades.length === 0) return {total:0,wins:0,winRate:0,netPL:0,profitFactor:'‚àû',maxDD:0,expectancy:0,avgWin:0,avgLoss:0,best:0,worst:0,winStreak:0};
      const wins = trades.filter(t => t.pl > 0);
      const losses = trades.filter(t => t.pl <= 0);
      const grossWin = wins.reduce((s,t) => s + t.pl, 0);
      const grossLoss = Math.abs(losses.reduce((s,t) => s + t.pl, 0));
      const profitFactor = grossLoss === 0 ? '‚àû' : (grossWin / grossLoss).toFixed(2);
      const winRate = (wins.length / trades.length * 100).toFixed(1);
      const netPL = trades.reduce((s,t) => s + t.pl, 0);

      // Max Drawdown
      const sorted = [...trades].sort((a,b) => new Date(a.date) - new Date(b.date));
      let equity = settings.initial;
      let peak = equity;
      let maxDD = 0;
      sorted.forEach(t => {
        equity += t.pl;
        if (equity > peak) peak = equity;
        const dd = peak > 0 ? ((peak - equity) / peak * 100) : 0;
        if (dd > maxDD) maxDD = dd;
      });

      // Win Streak
      let current = 0, maxStreak = 0;
      sorted.forEach(t => t.pl > 0 ? (current++, maxStreak = Math.max(maxStreak, current)) : current = 0);

      const expectancy = winRate/100 * (wins.length ? grossWin / wins.length : 0) - (1 - winRate/100) * (losses.length ? grossLoss / losses.length : 0);

      return {
        total: trades.length, wins: wins.length, winRate, netPL: netPL.toFixed(2), profitFactor, maxDD: maxDD.toFixed(2),
        expectancy: expectancy.toFixed(2), avgWin: wins.length ? (grossWin / wins.length).toFixed(2) : 0,
        avgLoss: losses.length ? (grossLoss / losses.length).toFixed(2) : 0, best: Math.max(...trades.map(t => t.pl), 0).toFixed(2),
        worst: Math.min(...trades.map(t => t.pl), 0).toFixed(2), winStreak: maxStreak
      };
    }

    function destroyCharts() {
      Object.values(charts).forEach(c => c?.destroy());
      charts = {};
    }

    function renderDashboard() {
      const s = calculateStats();
      const sorted = [...trades].sort((a,b) => new Date(a.date) - new Date(b.date));
      let equity = settings.initial;
      const equityData = [{x: 'Start', y: equity}];
      sorted.forEach(t => { equity += t.pl; equityData.push({x: t.date, y: equity.toFixed(2)}); });

      const monthly = {};
      sorted.forEach(t => {
        const m = luxon.DateTime.fromISO(t.date).toFormat('MMM yyyy');
        monthly[m] = (monthly[m] || 0) + t.pl;
      });

      const strategyMap = {};
      const assetMap = {};
      trades.forEach(t => {
        const strat = t.strategy || 'Untagged';
        strategyMap[strat] = (strategyMap[strat] || 0) + t.pl;
        assetMap[t.asset] = (assetMap[t.asset] || 0) + t.pl;
      });

      const content = `
        <h1 class="text-5xl font-bold mb-10 text-center">Pro Dashboard</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
          <div class="stat bg-base-200/80 rounded-box shadow-xl hover-glow p-6"><div class="stat-title">Total Trades</div><div class="stat-value text-primary">${s.total}</div></div>
          <div class="stat bg-base-200/80 rounded-box shadow-xl hover-glow p-6"><div class="stat-title">Win Rate</div><div class="stat-value text-success">${s.winRate}%</div></div>
          <div class="stat bg-base-200/80 rounded-box shadow-xl hover-glow p-6"><div class="stat-title">Net P/L</div><div class="stat-value ${s.netPL > 0 ? 'text-success' : 'text-error'}">${settings.currency}${s.netPL}</div></div>
          <div class="stat bg-base-200/80 rounded-box shadow-xl hover-glow p-6"><div class="stat-title">Profit Factor</div><div class="stat-value text-accent">${s.profitFactor}</div></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-8">
          <div class="card bg-base-200/80 shadow-xl p-6 card-hover"><h2 class="text-2xl font-bold mb-4">Equity Curve</h2><canvas id="equityChart"></canvas></div>
          <div class="card bg-base-200/80 shadow-xl p-6 card-hover"><h2 class="text-2xl font-bold mb-4">Monthly P/L</h2><canvas id="monthlyChart"></canvas></div>
          <div class="card bg-base-200/80 shadow-xl p-6 card-hover"><h2 class="text-2xl font-bold mb-4">Win/Loss</h2><canvas id="pieChart"></canvas></div>
          <div class="card bg-base-200/80 shadow-xl p-6 card-hover"><h2 class="text-2xl font-bold mb-4">By Strategy</h2><canvas id="strategyChart"></canvas></div>
          <div class="card bg-base-200/80 shadow-xl p-6 card-hover"><h2 class="text-2xl font-bold mb-4">By Asset</h2><canvas id="assetChart"></canvas></div>
        </div>
      `;
      renderContent(content);

      destroyCharts();
      charts.equity = new Chart(document.getElementById('equityChart'), {type: 'line', data: {datasets: [{label: 'Equity', data: equityData, borderColor: '#00ffaa', tension: 0.4, fill: true}]}, options: {scales: {x: {type: 'time', time: {unit: 'day'}}}}});
      charts.monthly = new Chart(document.getElementById('monthlyChart'), {type: 'bar', data: {labels: Object.keys(monthly), datasets: [{label: 'P/L', data: Object.values(monthly), backgroundColor: '#00ffaa'}]}});
      charts.pie = new Chart(document.getElementById('pieChart'), {type: 'doughnut', data: {labels: ['Wins', 'Losses'], datasets: [{data: [s.wins, s.total - s.wins], backgroundColor: ['#00ffaa', '#ff3366']}]}});
      charts.strategy = new Chart(document.getElementById('strategyChart'), {type: 'pie', data: {labels: Object.keys(strategyMap), datasets: [{data: Object.values(strategyMap), backgroundColor: ['#00ffaa', '#ffaa00', '#aa00ff', '#00aaff', '#ff00aa']}]}});
      charts.asset = new Chart(document.getElementById('assetChart'), {type: 'bar', data: {labels: Object.keys(assetMap), datasets: [{label: 'P/L', data: Object.values(assetMap), backgroundColor: '#3366ff'}]}});
    }

    function renderJournal() {
      const content = `
        <div class="flex justify-between mb-6"><h1 class="text-4xl font-bold">Trades Journal</h1>
          <div><input type="text" id="searchInput" placeholder="Search..." class="input input-bordered mr-4">
            <button class="btn btn-primary" onclick="exportCSV()">Export CSV</button>
            <button class="btn btn-secondary ml-2" onclick="document.getElementById('importFile').click()">Import CSV</button>
            <input type="file" id="importFile" accept=".csv" class="hidden" onchange="importCSV(this.files[0])">
          </div>
        </div>
        <div class="overflow-x-auto"><table class="table table-zebra w-full"><thead><tr><th>Date</th><th>Asset</th><th>Dir</th><th>Entry</th><th>Exit</th><th>SL</th><th>TP</th><th>Qty</th><th>P/L</th><th>R:R</th><th>Strategy</th><th>Image</th><th>Actions</th></tr></thead><tbody id="journalBody"></tbody></table></div>
      `;
      renderContent(content);
      const tbody = document.getElementById('journalBody');
      tbody.innerHTML = '';
      [...trades].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((t, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${t.date}</td><td>${t.asset}</td><td>${t.direction[0].toUpperCase()}</td><td>${t.entry}</td><td>${t.exit}</td><td>${t.sl || '-'}</td><td>${t.tp || '-'}</td><td>${t.quantity}</td>
          <td class="${t.pl > 0 ? 'text-success' : 'text-error'}">${settings.currency}${t.pl.toFixed(2)}</td><td>${t.rr ? t.rr.toFixed(2) : '-'}</td><td>${t.strategy || '-'}</td>
          <td>${t.image ? '<img src="' + t.image + '" class="w-32 rounded-box">' : '-'}</td>
          <td><button class="btn btn-sm btn-accent mr-2" onclick="editTrade(${i})">Edit</button><button class="btn btn-sm btn-error" onclick="deleteTrade(${i})">Delete</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function searchJournal() {
      const term = document.getElementById('searchInput').value.toLowerCase();
      const rows = document.querySelectorAll('#journalBody tr');
      rows.forEach(row => row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none');
    }

    function renderAdd() {
      editIndex = -1;
      const content = `
        <h1 class="text-4xl font-bold mb-8 text-center">${editIndex === -1 ? 'Add New' : 'Edit'} Trade</h1>
        <div class="card bg-base-200/80 shadow-xl max-w-4xl mx-auto p-8">
          <form id="tradeForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="form-control"><label class="label">Date</label><input type="date" class="input input-bordered" id="date" required></div>
              <div class="form-control"><label class="label">Asset</label><input type="text" class="input input-bordered" id="asset" required></div>
              <div class="form-control"><label class="label">Direction</label><select class="select select-bordered" id="direction"><option value="long">Long</option><option value="short">Short</option></select></div>
              <div class="form-control"><label class="label">Strategy</label><input type="text" class="input input-bordered" id="strategy"></div>
              <div class="form-control"><label class="label">Entry Price</label><input type="number" step="any" class="input input-bordered" id="entry" required></div>
              <div class="form-control"><label class="label">Exit Price</label><input type="number" step="any" class="input input-bordered" id="exit" required></div>
              <div class="form-control"><label class="label">Stop Loss</label><input type="number" step="any" class="input input-bordered" id="sl"></div>
              <div class="form-control"><label class="label">Take Profit</label><input type="number" step="any" class="input input-bordered" id="tp"></div>
              <div class="form-control"><label class="label">Quantity</label><input type="number" step="any" class="input input-bordered" id="quantity" required></div>
              <div class="form-control"><label class="label">Screenshot</label><input type="file" accept="image/*" class="file-input file-input-bordered" id="screenshot" onchange="previewImage(this)"></div>
              <div class="col-span-2"><img id="imagePreview" class="max-w-md rounded-box hidden"></div>
              <div class="form-control col-span-2"><label class="label">Reason Entry</label><textarea class="textarea textarea-bordered h-32" id="reason" required></textarea></div>
              <div class="form-control col-span-2"><label class="label">Notes</label><textarea class="textarea textarea-bordered h-32" id="notes"></textarea></div>
            </div>
            <div class="mt-8 text-center"><button type="submit" class="btn btn-primary btn-wide">Save Trade</button></div>
          </form>
        </div>
      `;
      renderContent(content);
      document.getElementById('tradeForm').onsubmit = saveTradeForm;
    }

    function previewImage(input) {
      if (input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
          document.getElementById('imagePreview').src = e.target.result;
          document.getElementById('imagePreview').classList.remove('hidden');
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    async function saveTradeForm(e) {
      e.preventDefault();
      const directionMult = document.getElementById('direction').value === 'long' ? 1 : -1;
      const entry = parseFloat(document.getElementById('entry').value);
      const exit = parseFloat(document.getElementById('exit').value);
      const qty = parseFloat(document.getElementById('quantity').value);
      const pl = (exit - entry) * qty * directionMult;
      let rr = null;
      const sl = document.getElementById('sl').value ? parseFloat(document.getElementById('sl').value) : null;
      if (sl) rr = Math.abs(exit - sl) / Math.abs(entry - sl);

      let image = null;
      const fileInput = document.getElementById('screenshot');
      if (fileInput.files[0]) {
        const reader = new FileReader();
        image = await new Promise(resolve => {
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(fileInput.files[0]);
        });
      } else if (editIndex !== -1 && trades[editIndex].image) image = trades[editIndex].image;

      const trade = {
        date: document.getElementById('date').value,
        asset: document.getElementById('asset').value,
        direction: document.getElementById('direction').value,
        strategy: document.getElementById('strategy').value,
        entry, exit, sl, tp: document.getElementById('tp').value ? parseFloat(document.getElementById('tp').value) : null,
        quantity: qty, reason: document.getElementById('reason').value, notes: document.getElementById('notes').value,
        pl, rr, image
      };

      if (editIndex === -1) trades.push(trade);
      else trades[editIndex] = trade;

      saveTrades();
      showTab('dashboard');
    }

    function editTrade(i) {
      editIndex = i;
      const t = trades[i];
      renderAdd();
      document.getElementById('date').value = t.date;
      document.getElementById('asset').value = t.asset;
      document.getElementById('direction').value = t.direction;
      document.getElementById('strategy').value = t.strategy || '';
      document.getElementById('entry').value = t.entry;
      document.getElementById('exit').value = t.exit;
      document.getElementById('sl').value = t.sl || '';
      document.getElementById('tp').value = t.tp || '';
      document.getElementById('quantity').value = t.quantity;
      document.getElementById('reason').value = t.reason;
      document.getElementById('notes').value = t.notes || '';
      if (t.image) {
        document.getElementById('imagePreview').src = t.image;
        document.getElementById('imagePreview').classList.remove('hidden');
      }
    }

    function deleteTrade(i) {
      if (confirm('Yakin hapus trade ini?')) {
        trades.splice(i, 1);
        saveTrades();
        renderJournal();
      }
    }

    function renderStats() {
      const s = calculateStats();
      const content = `
        <h1 class="text-4xl font-bold mb-8 text-center">Advanced Statistics</h1>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="stat bg-base-200/80 rounded-box shadow-xl hover-glow p-6"><div class="stat-title">Expectancy</div><div class="stat-value">${s.expectancy}</div></div>
          <div class="stat bg-base-200/80 rounded-box shadow-xl hover-glow p-6"><div class="stat-title">Avg Win</div><div class="stat-value text-success">${settings.currency}${s.avgWin}</div></div>
          <div class="stat bg-base-200/80 rounded-box shadow-xl hover-glow p-6"><div class="stat-title">Avg Loss</div><div class="stat-value text-error">${settings.currency}${s.avgLoss}</div></div>
          <div class="stat bg-base-200/80 rounded-box shadow-xl hover-glow p-6"><div class="stat-title">Best Trade</div><div class="stat-value text-success">${settings.currency}${s.best}</div></div>
          <div class="stat bg-base-200/80 rounded-box shadow-xl hover-glow p-6"><div class="stat-title">Worst Trade</div><div class="stat-value text-error">${settings.currency}${s.worst}</div></div>
          <div class="stat bg-base-200/80 rounded-box shadow-xl hover-glow p-6"><div class="stat-title">Max Win Streak</div><div class="stat-value text-accent">${s.winStreak}</div></div>
          <div class="stat bg-base-200/80 rounded-box shadow-xl hover-glow p-6 col-span-3"><div class="stat-title">Max Drawdown</div><div class="stat-value text-error">${s.maxDD}%</div></div>
        </div>
      `;
      renderContent(content);
    }

    function renderSettings() {
      const content = `
        <h1 class="text-4xl font-bold mb-8 text-center">Settings</h1>
        <div class="card bg-base-200/80 shadow-xl max-w-xl mx-auto p-8">
          <div class="form-control"><label class="label">Initial Capital</label><input type="number" class="input input-bordered" id="initialCapital" value="${settings.initial}"></div>
          <div class="form-control"><label class="label">Currency Symbol</label><input type="text" class="input input-bordered" id="currency" value="${settings.currency}"></div>
          <div class="form-control mt-6"><label class="label cursor-pointer"><span class="label-text">Dark Mode</span><input type="checkbox" class="toggle toggle-primary" id="darkToggle" ${settings.theme === 'dark' ? 'checked' : ''}></label></div>
          <div class="mt-8 text-center"><button class="btn btn-primary" onclick="saveSettingsFromForm()">Save Settings</button></div>
        </div>
      `;
      renderContent(content);
    }

    function saveSettingsFromForm() {
      settings.initial = parseFloat(document.getElementById('initialCapital').value) || 10000;
      settings.currency = document.getElementById('currency').value || '$';
      settings.theme = document.getElementById('darkToggle').checked ? 'dark' : 'light';
      saveSettings();
    }

    function exportCSV() {
      let csv = 'Date,Asset,Direction,Strategy,Entry,Exit,SL,TP,Quantity,P/L,R:R,Reason,Notes\n';
      trades.forEach(t => csv += `${t.date},${t.asset},${t.direction},${t.strategy||''},${t.entry},${t.exit},${t.sl||''},${t.tp||''},${t.quantity},${t.pl},${t.rr||''},"${t.reason}","${t.notes||''}"\n`);
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'kandar-capital.csv'; a.click();
    }

    function importCSV(file) {
      const reader = new FileReader();
      reader.onload = e => {
        const lines = e.target.result.split('\n').slice(1);
        lines.forEach(line => {
          if (!line.trim()) return;
          const vals = line.split(',');
          trades.push({
            date: vals[0], asset: vals[1], direction: vals[2], strategy: vals[3], entry: parseFloat(vals[4]), exit: parseFloat(vals[5]),
            sl: vals[6] ? parseFloat(vals[6]) : null, tp: vals[7] ? parseFloat(vals[7]) : null, quantity: parseFloat(vals[8]),
            reason: vals[10].replace(/^"(.*)"$/, '$1'), notes: vals[11]?.replace(/^"(.*)"$/, '$1') || '', pl: parseFloat(vals[9]), rr: vals[10] ? parseFloat(vals[10]) : null, image: null
          });
        });
        saveTrades();
        showTab('journal');
      };
      reader.readAsText(file);
    }

    function renderAll() {
      if (document.getElementById('main-content').innerHTML.includes('Dashboard')) renderDashboard();
      if (document.getElementById('main-content').innerHTML.includes('Journal')) renderJournal();
    }

    function showTab(tab) {
      if (tab === 'dashboard') renderDashboard();
      else if (tab === 'journal') renderJournal();
      else if (tab === 'add') renderAdd();
      else if (tab === 'stats') renderStats();
      else if (tab === 'settings') renderSettings();
    }

    applySettings();
    showTab('dashboard');
  </script>
</body>
</html>
